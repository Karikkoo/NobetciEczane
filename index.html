<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>En Yakın Nöbetçi Eczane</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #eef2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 30px 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        #loader {
            text-align: center;
        }
        #loader p {
            font-size: 1.2em;
            color: #555;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #d9534f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #result {
            display: none;
        }
        h1 {
            color: #d9534f;
            margin-bottom: 10px;
        }
        h2 {
            font-size: 1.5em;
            margin-top: 0;
            color: #2c3e50;
        }
        #eczane-adresi {
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        #eczane-mesafe {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            font-size: 1.1em;
            font-weight: 500;
            color: #495057;
            margin-bottom: 25px;
        }
        #navigasyon-linki {
            display: inline-block;
            background-color: #d9534f;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 1.2em;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        #navigasyon-linki:hover {
            background-color: #c9302c;
        }
        #error {
            color: #a94442;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="container">
        <div id="loader">
            <div class="spinner"></div>
            <p>En yakın nöbetçi eczane bulunuyor...</p>
            <p>Lütfen konum izni verin.</p>
        </div>
        <div id="result">
            <h1>En Yakın Nöbetçi Eczane</h1>
            <h2 id="eczane-adi"></h2>
            <p id="eczane-adresi"></p>
            <p id="eczane-mesafe"></p>
            <a id="navigasyon-linki" href="#" target="_blank">Yol Tarifi Al</a>
        </div>
        <div id="error" style="display: none;"></div>
    </div>

    <script>
        // --------- AYARLAR ---------
        const API_KEY = "apikey 0pasm8rEEZPSOmSSkeJahc:0xtvEIK0zNpl2o7ZxfB4RQ"; // CollectAPI'den aldığınız API anahtarını buraya yapıştırın.
        const IL = "Ankara";      // Eczanenin bulunduğu il
        const ILCE = "Çankaya";   // Eczanenin bulunduğu ilçe (isteğe bağlı)
        // -------------------------

        window.onload = findNearestPharmacy;

        function findNearestPharmacy() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById("error").innerHTML = "Tarayıcınız konum servisini desteklemiyor.";
                document.getElementById("error").style.display = 'block';
                document.getElementById("loader").style.display = 'none';
            }
        }

        async function showPosition(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            
            try {
                const pharmacies = await fetchPharmacies();
                if (pharmacies.length === 0) {
                    document.getElementById("error").innerHTML = `<b>${IL} / ${ILCE}</b> için nöbetçi eczane bulunamadı.`;
                    document.getElementById("error").style.display = 'block';
                    document.getElementById("loader").style.display = 'none';
                    return;
                }

                const nearest = calculateNearest(userLat, userLon, pharmacies);
                displayResult(userLat, userLon, nearest.pharmacy, nearest.distance);

            } catch (error) {
                document.getElementById("error").innerHTML = "Eczane verileri alınırken bir hata oluştu: " + error.message;
                document.getElementById("error").style.display = 'block';
                document.getElementById("loader").style.display = 'none';
            }
        }

        async function fetchPharmacies() {
            const url = `https://api.collectapi.com/health/dutyPharmacy?ilce=${encodeURIComponent(ILCE)}&il=${encodeURIComponent(IL)}`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'content-type': 'application/json',
                    'authorization': API_KEY
                }
            });

            if (!response.ok) {
                throw new Error('API isteği başarısız oldu. API anahtarınızı kontrol edin.');
            }

            const data = await response.json();
            return data.result || [];
        }
        
        function calculateNearest(userLat, userLon, pharmacies) {
            let minDistance = Infinity;
            let nearestPharmacy = null;

            pharmacies.forEach(pharmacy => {
                const locParts = pharmacy.loc.split(',');
                const pharmacyLat = parseFloat(locParts[0]);
                const pharmacyLon = parseFloat(locParts[1]);
                
                const distance = calculateDistance(userLat, userLon, pharmacyLat, pharmacyLon);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPharmacy = pharmacy;
                }
            });

            return { pharmacy: nearestPharmacy, distance: minDistance };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Dünya'nın yarıçapı (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Mesafe (km)
        }

        function displayResult(userLat, userLon, pharmacy, distance) {
            document.getElementById("loader").style.display = 'none';
            document.getElementById("result").style.display = 'block';

            document.getElementById("eczane-adi").innerText = pharmacy.name;
            document.getElementById("eczane-adresi").innerText = pharmacy.address;
            document.getElementById("eczane-mesafe").innerText = `Mesafe: Yaklaşık ${distance.toFixed(2)} km`;

            const navLink = document.getElementById("navigasyon-linki");
            const destination = pharmacy.loc || encodeURIComponent(pharmacy.address);
            navLink.href = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${destination}`;
        }

        function showError(error) {
            const errorEl = document.getElementById("error");
            errorEl.style.display = 'block';
            document.getElementById("loader").style.display = 'none';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorEl.innerHTML = "Konum izni reddedildi. En yakın eczaneyi bulmak için lütfen konum izni verin.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorEl.innerHTML = "Konum bilgisi alınamıyor.";
                    break;
                case error.TIMEOUT:
                    errorEl.innerHTML = "Konum bilgisi alma isteği zaman aşımına uğradı.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorEl.innerHTML = "Bilinmeyen bir hata oluştu.";
                    break;
            }
        }
    </script>

</body>
</html>
